# 项目上线配置说明

## ✅ 已完成的配置

### 1. 数据库迁移到 MySQL
- ✅ 已安装 `aiomysql` 和 `pymysql` 驱动
- ✅ 已修改 `backend/app/config/database.py` 支持 MySQL
- ✅ 已修改 `backend/init_db.py` 支持 MySQL
- ✅ 已创建数据库：`physmath`
- ✅ 已创建数据库表：`users`, `animations`, `animation_likes`
- ✅ MySQL 配置信息已写入 `.env`

### 2. 前端 URL 硬编码修复
- ✅ 创建了统一的 API 配置文件 `frontend/src/config/api.js`
- ✅ 修改了所有组件，移除硬编码 URL：
  - `LikeButton.jsx` - 4处
  - `MyAnimationsPanel.jsx` - 5处
  - `PhysicsInputBox.jsx` - 1处
  - `PlazaPanel.jsx` - 2处
  - `SaveAnimationModal.jsx` - 2处
  - `ShareLinkModal.jsx` - 2处
  - `PlayPage.jsx` - 2处

### 3. 环境变量配置
- ✅ 创建了前端开发环境配置：`frontend/.env.development`
- ✅ 创建了前端生产环境配置：`frontend/.env.production`
- ✅ 后端 `.env` 已配置：
  - MySQL 数据库连接
  - JWT 密钥（已生成强随机密钥）
  - 前端跨域域名

---

## 📋 上线前必须修改的配置

### 1. 确认生产域名
请在以下文件中确认/修改你的生产域名：

#### 前端配置（`frontend/.env.production`）
```bash
VITE_API_BASE_URL=https://physmath.cn
VITE_APP_BASE_URL=https://physmath.cn
```

#### 后端配置（`.env`）
```bash
FRONTEND_ORIGINS=https://physmath.cn,https://www.physmath.cn
```

### 2. HTTPS 配置
上线时需要配置 HTTPS 证书（建议使用宝塔面板一键申请 Let's Encrypt 证书）

### 3. 构建前端生产版本
```bash
cd /root/12.26/frontend
npm run build
```

构建完成后，`dist` 目录就是生产静态文件。

---

## 🚀 部署步骤

### 方式一：宝塔面板部署

#### 后端部署
1. 使用 PM2 或 supervisor 管理后端进程
2. 启动命令：
```bash
cd /root/12.26
source myenv/bin/activate
uvicorn backend.app.main:app --host 0.0.0.0 --port 8000
```

#### 前端部署
1. 构建生产版本：`npm run build`
2. 在宝塔面板创建网站，指向 `frontend/dist` 目录
3. 配置 Nginx 反向代理：
```nginx
# API 请求转发到后端
location /api/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /physics/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /uploads/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /auth/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

# 前端 SPA 路由支持
location / {
    try_files $uri $uri/ /index.html;
}
```

---

## 🔒 安全建议

### 1. 已完成的安全措施
- ✅ JWT 密钥已使用强随机密钥
- ✅ MySQL 密码已设置为强密码
- ✅ 数据库仅允许本地连接

### 2. 建议添加的安全措施
- [ ] 配置防火墙，只开放 80、443 端口
- [ ] 配置 Nginx 限流（防止 DDoS）
- [ ] 添加 API 请求频率限制
- [ ] 配置日志文件
- [ ] 定期备份数据库和上传文件

---

## 📦 备份策略

### 数据库备份
使用宝塔面板的数据库自动备份功能，或手动备份：
```bash
mysqldump -u physmath -p physmath > backup_$(date +%Y%m%d).sql
```

### 上传文件备份
定期备份 `backend/uploads/` 目录：
```bash
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz backend/uploads/
```

---

## 🛠️ 测试检查清单

上线前请完成以下测试：

### 前端测试
- [ ] 用户注册/登录功能
- [ ] 上传图片并识别物体
- [ ] 保存动画到我的动画
- [ ] 发布动画到广场
- [ ] 点赞功能
- [ ] 分享链接功能
- [ ] Fork 他人动画

### 后端测试
- [ ] 数据库连接正常
- [ ] API 响应正常
- [ ] 文件上传功能
- [ ] SAM 模型加载正常
- [ ] JWT Token 验证正常

### 性能测试
- [ ] 页面加载速度
- [ ] API 响应时间
- [ ] 并发访问测试

---

## 🔧 常见问题

### Q: 前端无法连接后端
**A:** 检查以下项：
1. 后端服务是否启动（端口 8000）
2. Nginx 反向代理配置是否正确
3. CORS 配置是否包含前端域名
4. 防火墙是否开放端口

### Q: 登录后 Token 失效
**A:** 检查：
1. JWT_SECRET_KEY 是否一致
2. 服务器时间是否正确
3. Token 过期时间配置

### Q: 图片上传失败
**A:** 检查：
1. `backend/uploads/` 目录权限
2. Nginx 上传大小限制：`client_max_body_size`
3. 磁盘空间是否充足

---

## 📞 技术栈版本

- **后端**: Python 3.12 + FastAPI + MySQL 5.7
- **前端**: React 18 + Vite 5
- **AI 模型**: Segment Anything (SAM) + 豆包多模态
- **部署**: 宝塔面板 + Nginx

---

## 📝 更新日志

### 2026-01-23
- ✅ 迁移数据库从 SQLite 到 MySQL
- ✅ 修复所有前端硬编码 URL
- ✅ 配置环境变量系统
- ✅ 生成强随机 JWT 密钥
- ✅ 创建上线配置文档
