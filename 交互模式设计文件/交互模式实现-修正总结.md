# 交互模式实现规划 - 修正总结

## 核心概念修正

### ✅ 已修正的关键概念

#### 1. 模拟模式 vs 交互模式

**错误理解**：
- ❌ 交互模式有"播放/暂停"按钮可以切换
- ❌ 用户可以在前端选择模式
- ❌ 两种模式只是是否允许拖拽的区别

**正确理解**：
- ✅ **后端大模型自动判断**使用哪种模式
- ✅ **模拟模式**：有初速度参数，物体立即运动，用户不可拖拽
- ✅ **交互模式**：无初速度参数，物体静止，用户可拖拽探索
- ✅ 两种模式通过 `mode` 字段区分，前端无需切换按钮

#### 2. UI 设计

**错误设计**：
- ❌ 右上角有播放/暂停按钮
- ❌ 交互模式可以切换到播放模式

**正确设计**：
- ✅ 交互模式：右下角显示"🔄 重置场景"按钮
- ✅ 模拟模式：无重置按钮
- ✅ 没有播放/暂停切换功能

#### 3. 精灵图显示

**新增要求**：
- ✅ 定滑轮、动滑轮需要显示精灵图
- ✅ 轻杆需要显示精灵图
- ✅ 精灵图随物体/杆旋转
- ✅ 如果没有精灵图，显示简化图形

---

## 修正后的文档列表

### 1. 交互模式实现规划-总览-修正版.md
**核心内容**：
- 明确两种模式的区别
- 后端返回数据格式
- 用户完整流程
- 典型场景对比

### 2. 交互模式实现-第一步-基础框架.md（已修正）
**核心修改**：
- 根据 `mode` 字段判断是否添加鼠标交互
- 移除播放/暂停切换功能
- 交互模式显示重置按钮（右下角）
- 两种模式对比表

### 3. 交互模式实现-第二步-绳子系统.md
**保持不变**：
- Verlet 绳子系统实现正确
- 无需修改

### 4. 交互模式实现-第三步-滑轮系统.md（已修正）
**核心修改**：
- 添加精灵图支持
- 优先显示精灵图，没有则显示简化图形
- 滑轮旋转与精灵图同步

### 5. 交互模式实现-第四步-轴心轻杆.md（已修正）
**核心修改**：
- 添加精灵图支持
- 轻杆精灵图随旋转同步
- 没有精灵图则显示灰色线

### 6. 交互模式实现-第五步-联动测试.md
**需要微调**：
- 场景测试基于正确的模式理解
- 无需修改核心算法

---

## 关键实现要点

### 后端返回数据格式

**模拟模式示例**：
```json
{
  "mode": "simulation",
  "enableInteraction": false,
  "objects": [
    {
      "name": "滑块A",
      "role": "dynamic",
      "parameters": {
        "initial_velocity_px_s": 200,
        "mass_kg": 2
      },
      "sprite": {
        "url": "/sprites/block.png"
      }
    }
  ]
}
```

**交互模式示例**：
```json
{
  "mode": "interactive",
  "enableInteraction": true,
  "objects": [
    {
      "name": "摆球",
      "role": "dynamic",
      "parameters": {
        "mass_kg": 1
      },
      "sprite": {
        "url": "/sprites/ball.png"
      }
    },
    {
      "name": "定滑轮",
      "role": "pulley_fixed",
      "sprite": {
        "url": "/sprites/fixed_pulley.png",
        "width": 60,
        "height": 60
      }
    }
  ],
  "constraints": [
    {
      "constraintType": "rope",
      "startPoint": {...},
      "endPoint": {...}
    },
    {
      "constraintType": "pivot_rod",
      "pivotName": "轴心点",
      "bodyName": "摆球",
      "length": 150,
      "sprite": {
        "url": "/sprites/rod.png",
        "width": 10,
        "height": 150
      }
    }
  ]
}
```

---

### 前端核心代码结构

```javascript
// PhysicsInputBox.jsx
const handleStartSimulate = async () => {
  const response = await axios.post('/api/simulate', {...});
  const { mode, enableInteraction, objects, constraints } = response.data;
  
  // 保存模式
  setSimulationMode(mode);
  
  // 创建模拟
  const sim = runSimulation({
    mode,
    enableInteraction,
    objects,
    constraints,
    ...
  });
};

// physicsEngine.js
export function runSimulation({ mode, enableInteraction, objects, ... }) {
  
  // 创建物体（带精灵图）
  objects.forEach(obj => {
    const body = Bodies.fromVertices(..., {
      render: {
        sprite: obj.sprite ? {
          texture: obj.sprite.url,
          xScale: sx,
          yScale: sy
        } : undefined
      }
    });
  });
  
  // 只在交互模式下添加鼠标约束
  if (mode === 'interactive' && enableInteraction) {
    const mouseConstraint = MouseConstraint.create(engine, {...});
    Composite.add(engine.world, mouseConstraint);
  }
  
  // 两种模式都立即启动
  Runner.run(runner, engine);
  
  return { mode, ... };
}
```

---

## 用户体验对比

### 模拟模式体验

```
1. 上传滑块碰撞图片（有速度参数）
   ↓
2. 后端识别：mode = "simulation"
   ↓
3. 用户框选元素确认
   ↓
4. 点击"创建模拟"
   ↓
5. 【立即播放】
   - 滑块A 以初速度运动
   - 碰撞滑块B
   - 用户只能观看
   - 无法拖拽
   - 右下角无按钮
```

### 交互模式体验

```
1. 上传滑轮组图片（无速度参数）
   ↓
2. 后端识别：mode = "interactive"
   ↓
3. 用户框选元素确认
   ↓
4. 点击"创建模拟"
   ↓
5. 【物理沙盒】
   - 物体静止（受重力）
   - 用户可拖拽重物
   - 观察动滑轮被托起
   - 右下角显示"🔄 重置场景"
   ↓
6. 拖拽探索
   - 拖动重物向下
   - 动滑轮上升
   - 滑轮旋转
   ↓
7. 点击"🔄 重置场景"
   - 物体回到初始位置
   - 继续探索
```

---

## 实现清单

### 第一步：模式判断（1-2天）
- [ ] 前端根据 `mode` 字段判断
- [ ] 交互模式添加鼠标约束
- [ ] 交互模式显示重置按钮（右下角）
- [ ] 移除播放/暂停功能
- [ ] 测试两种模式切换

### 第二步：绳子系统（2-3天）
- [ ] Verlet 绳子物理
- [ ] 鼠标交互创建绳子
- [ ] 绳子实时预览
- [ ] 绳子拉力传递

### 第三步：滑轮系统（2-3天）
- [ ] 定滑轮与动滑轮识别
- [ ] 绳子绕过滑轮算法
- [ ] 滑轮旋转计算
- [ ] **滑轮精灵图显示**
- [ ] 精灵图旋转同步

### 第四步：轴心轻杆（1天）
- [ ] 轴心点固定
- [ ] 轻杆刚性约束
- [ ] **轻杆精灵图显示**
- [ ] 单摆/圆周运动

### 第五步：联动测试（1-2天）
- [ ] 复杂场景测试
- [ ] 性能优化
- [ ] 参数调优
- [ ] 完整测试清单

---

## 关键注意事项

### ⚠️ 必须注意

1. **模式由后端决定**
   - 前端不提供模式切换UI
   - 根据 `mode` 字段自动配置

2. **精灵图优先**
   - 滑轮、轻杆优先显示精灵图
   - 没有精灵图时显示简化图形
   - 精灵图需要跟随旋转

3. **交互模式特性**
   - 物体无初速度（静止）
   - 用户可拖拽
   - 右下角重置按钮
   - 没有播放/暂停

4. **模拟模式特性**
   - 物体有初速度（运动）
   - 用户不可拖拽
   - 无重置按钮
   - 纯观看模式

---

## 测试场景

### 模拟模式测试
- 滑块碰撞（有速度）
- 抛体运动（有角度）
- 确认：物体立即运动，无法拖拽

### 交互模式测试
- 滑轮组（无初速度）
- 单摆（用户选择角度）
- 轻杆旋转
- 确认：物体静止，可拖拽，有重置按钮

---

**修正完成时间**：2025-12-20  
**总文档数**：6 个  
**核心修正点**：3 个
- ✅ 模式由后端判断
- ✅ 移除播放/暂停切换
- ✅ 添加精灵图支持

